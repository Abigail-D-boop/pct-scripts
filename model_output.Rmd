---
title: "Propensity to Cycle Tool - local results"
author: "Created by the PCT team"
output:
  html_document:
    fig_caption: yes
    highlight: pygments
    theme: null
    toc: yes
---

<!--Anna suggested two places where we should change commutes to commuters - I wasn't 100% sure which these were so have left it. Slightly confusing as we are using 'commutes' to refer to OD pairs, whereas numbers of actual commutes by commuters will be higher...-->

```{r, include=FALSE}
source("set-up.R")
knitr::opts_chunk$set(message = FALSE)

# Read-in the data
if(!exists("region")) region <- "cambridgeshire"
pct_data <- file.path("..", "pct-data")
pct_bigdata <- file.path("..", "pct-bigdata")
zones = readRDS(file.path(pct_data, region, "z.Rds"))
cents = readRDS(file.path(pct_data, region, "c.Rds"))
l = readRDS(file.path(pct_data, region, "l.Rds"))
rf = readRDS(file.path(pct_data, region, "rf.Rds"))
rq = readRDS(file.path(pct_data, region, "rq.Rds"))
rnet = readRDS(file.path(pct_data, region, "rnet.Rds"))
params = readRDS(file.path(pct_data, region, "params.Rds"))
list2env(x = params, envir = globalenv())
source('shared_build.R')
dfscen <- dplyr::select(l@data, contains("slc"), -contains("co2"), All, olc = Bicycle, dist_fast)
dfsp <- gather(dfscen, key = scenario, value = slc, -dist_fast)
dfsp$scenario <- factor(dfsp$scenario)
dfsp$scenario <-
  factor(dfsp$scenario, levels = levels(dfsp$scenario)[c(1, 3, 2, 4, 5, 6)])
levels(dfsp$scenario)[1] <- c("All modes")
levels(dfsp$scenario)[6] <- c("Current (2011)")

las_in_region <- gIntersects(las_cents, region_shape, byid = T)
las_in_region <- las_in_region[1,]
las_in_region <- las[las_in_region,]
```

## Key information 
This document provides more information about the data underlying the Propensity to Cycle Tool (PCT) for `r R.utils::capitalize(region)`. The data was generated on `r build_date` and this document was created on `r Sys.Date()`. The PCT is an open source tool for sustainable transport planning, released under the conditions of the [AGPL Licence](https://www.gnu.org/licenses/agpl-3.0).Both the [pct](https://github.com/npct/pct) and [pct-shiny](https://github.com/npct/pct-shiny) can be modified by others given attribution to the original.

This version of the PCT uses origin-destination (OD) data on travel to work from the 2011 Census. The dataset reports the number of people travelling by different modes from Middle Super Output Area ([MSOA](https://data.gov.uk/dataset/middle-layer-super-output-areas-2001-to-middle-layer-super-output-areas-2011-to-local-authority)) zones. There were
`r prettyNum(sum(zones$All), big.mark = ",", scientific = F)`
commuters in the study area from this data source. All of these are represented in the area data produced by the PCT.  

<!-- as discussed can we please insert actual not rounded number-->

Lines on the interactive map  represent flows between zones in `r R.utils::capitalize(region)`. This excludes
within-zone travel (`r round(sum(cents$All) / sum(zones$All) * 100)`% of commutes in `r R.utils::capitalize(region)`), commuters travelling outside `r R.utils::capitalize(region)` and people with no fixed place of work. Within `r R.utils::capitalize(region)` there are `r n_flow_region / 1000` between-zone OD pairs. Of these, `r round(nrow(l) / n_flow_region * 100)`% are represented as lines on the interactive map. The selection criteria used for this were (i) distance of less than 
`r params$mdist`km and (ii) more than `r params$mflow` (by any mode). The resultant `r nrow(l)` desire lines account for `r round(sum(l$All) / sum(zones$All) * 100)`% of all commuters in `r R.utils::capitalize(region)` and
`r round(sum(l$All) / params$n_commutes_region * 100)`%
of between-zone commutes taking place within `r R.utils::capitalize(region)`.

See ([Lovelace et al.](http://arxiv.org/abs/1509.04425)) for details of the methods we used to estimate the cycling, health and carbon impacts of each scenario, and to visualise results at the area, line, route and route network level.

## The `r R.utils::capitalize(region)` region

<!-- Can we show hilliness by comparison to other areas?  -->

```{r distance-dist, echo=FALSE, fig.cap="The above graph shows the study region (thick black border), selected zones (grey), the administrative zone region (red line) and local authorities (blue line). The black straight green represents the most intensive commuting OD pairs.", echo=FALSE, message=FALSE, warning=FALSE}

plot(zones, col = "lightgrey")
plot(regions, add = T)
plot(las_in_region, border = "blue", add = T, lwd = 2)
plot(region_orig, lwd = 5, add = T)
plot(region_shape, border = "red", add = T, lwd = 2)
lines(l[l$All > 100,], col = "green")
```

The average hilliness of zones in `r R.utils::capitalize(region)` is
`r round(100 * mean(zones$avslope), 1)`
percent.

```{r, echo = FALSE}
# # It used to say - see below. What to replace this with?
# compared with the national average of
# `r round(mean(ukmsoas$avslope, na.rm = T), 1)`. This data is displayed in the
# figure below.
tm_shape(zones) +
  tm_fill("avslope", n = 3, palette = "Oranges")
```

## Cycling levels in each scenario for `r R.utils::capitalize(region)`

The proportion of cyclists in the baseline data in `r R.utils::capitalize(region)` is xx% <!-- please calculate-->, compared to national proportions of 3.2%. The proportion of cyclists is shown in the table below, alongside the proportion of people walking, driving and using other modes.


<!--As discussed with Anna - can we please have here a table for the whole region per scenario, using area-based data? This would look like the following
                              % cyclists  % walking % car drivers % all other modes
  Census 2011
  Government Target
  Gender Equity
  Go Dutch
  Ebikes
-->

<!--I think we either need to remove this graph or make clearer source of data - what is included? Are we including within zone-based trips?
-->
```{r, echo=FALSE, warning=FALSE, fig.cap="Rate of cycling in model scenarios. Note the total percentage cycling is equal to the area under each line."}
levels(dfsp$scenario) <- gsub("_slc", "", levels(dfsp$scenario))
levels(dfsp$scenario) <- R.utils::capitalize(levels(dfsp$scenario))
levels(dfsp$scenario)[2:5] = c("Ebikes", "Go Dutch", "Gender Equality", "Government Target")
ggplot(dfsp) +
  geom_freqpoly(aes(dist_fast, weight = slc,
    color = scenario), binwidth = 1) +
  ylab("Number of trips per day") +
  xlab("Route distance (km)") +
  scale_color_discrete(name = "Mode and\nscenario\n(cycling)") +
  xlim(c(0,12)) +
  theme_bw()

```

## Health and carbon impacts

A modified
version of the 2014 [HEAT tool](http://www.euro.who.int/en/health-topics/environment-and-health/Transport-and-health/publications/2011/health-economic-assessment-tools-heat-for-walking-and-for-cycling.-methodology-and-user-guide.-economic-assessment-of-transport-infrastructure-and-policies.-2014-update)
was used to calculate health impacts. CO2 impacts are derived from changes in distance driven per scenario.

The table below illustrates the health and carbon impacts of the different scenarios.

<!-- please create table below.

Scenario      Comparison                  Mortality Impacts                        Change in MTCO2e/year
                              Change in deaths/yr Value of change (Â£, millions)
Census 2011  'No Cyclists'
Govt Target 'No Cyclists'
            Census 2011
Gender equity 'No Cyclists'
            Census 2011
Go Dutch 'No Cyclists'
            Census 2011
Ebikes 'No Cyclists'
            Census 2011

